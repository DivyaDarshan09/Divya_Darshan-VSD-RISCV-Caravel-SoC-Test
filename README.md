# Divya_Darshan-VSD-RISCV-Caravel-SoC-Test


1. Environment Setup

This section documents the preparation of the environment required to run Caravel’s HK SPI functional and GLS verification.
All setup was done on a Linux system with the necessary open-source EDA tools.

1.1 Caravel Repository Setup

The official Caravel SoC repository was already downloaded earlier using:

git clone https://github.com/efabless/caravel


The repository contains:

Caravel wrapper RTL

Housekeeping modules

Management SoC (RISC-V core)

User project interface

Verification testbenches

Build system and utilities

This forms the base for running the hkspi verification.

1.2 Sky130 PDK Installation (Using Volare)

The Sky130 PDK was installed using Volare, Efabless’s PDK version manager.
Volare simplifies installation by automatically fetching and organizing the correct PDK version for Caravel and OpenLane.

1.2.1 Setting Environment Variables

The following variables were added to the ~/.bashrc file:

export PDK_ROOT=$HOME/.volare/volare
export PDK=sky130
export PDK_VERSION=0fe599b2afb6708d281543108caf8310912f54af


Explanation:

Variable	Purpose
PDK_ROOT	Points to the directory where Volare stores PDKs
PDK	Specifies the PDK family (sky130)
PDK_VERSION	Identifies the exact Sky130 version installed

The environment was reloaded:

source ~/.bashrc

1.2.2 Verifying the Volare Directory Structure

Running:

ls -l ~/.volare


shows symbolic links pointing to Volare-managed Sky130 versions:

sky130 -> /home/.../.volare/volare/sky130
sky130A -> volare/sky130/versions/<hash>/sky130A
sky130B -> volare/sky130/versions/<hash>/sky130B
volare/


This confirms:

sky130A and sky130B PDKs are installed

Volare manages PDK versioning correctly

Symlinks point to correct versions

1.2.3 Validating the PDK Contents

To ensure the selected version exists:

ls $PDK_ROOT/$PDK/versions/$PDK_VERSION


Expected subdirectories were present:

libs.ref

libs.tech

sky130_fd_pr

sky130_fd_sc_hd

sky130_fd_sc_hvl

sky130_ml_xx_hd

sky130_sram_macros

These include SPICE models, GDS, Magic/KLayout tech files, standard cell libraries, and SRAM macros.
This confirms that the PDK installation is complete and ready for simulation and physical design.

1.3 Tool Verification

The following tools required for Caravel DV and OpenLane flows were verified to run correctly:

Tool	Purpose
iverilog	RTL simulation
vvp	Executes compiled Icarus Verilog output
verilator	Linting, C++ simulation model generation
OpenLane + OpenROAD	Synthesis, PnR, STA
Magic / KLayout	Layout viewing, DRC/LVS
Sky130 PDK (Volare)	Technology + standard cell libraries

Each tool launched successfully. Version screenshots were saved as proof.

2. Understanding the HK SPI Test

The HK SPI (Housekeeping SPI) is a core interface inside Caravel used for communication between:

The Management SoC (RISC-V)

The Housekeeping controller

The User project wrapper

Caravel’s DV directory contains a dedicated test for verifying the housekeeping SPI module.

The hkspi test is located in:

caravel/verilog/dv/hkspi/

2.1 Files Analyzed
File	Description
hkspi_tb.v	Main testbench that drives SPI transactions
housekeeping_spi.v	RTL implementation of the SPI protocol
hkspi.hex	Command sequence loaded into testbench
2.2 hkspi_tb.v – Testbench Overview

The testbench performs the following:

Loads command vectors from hkspi.hex

Generates SPI signals:

sck (clock)

csb (chip select)

mosi (input)

Drives these signals to the housekeeping_spi module

Captures the module's response on miso

Verifies:

Register read/writes

Mode configurations

Expected behavioral correctness

It simulates the type of SPI traffic normally generated by the Management SoC firmware.

2.3 housekeeping_spi.v – RTL Overview

This module implements SPI protocol handling inside Caravel.

Key functionalities:

Receives SPI commands from the SoC

Decodes instructions:

Address

Read/write

Configurations

Updates internal housekeeping registers

Provides data back to the master through MISO

Controls important signals:

GPIO mode controlling

Analog/digital enable

Reset logic

User project power/reset sequencing

This module is critical for initial chip configuration.

2.4 hkspi.hex – SPI Command Vector File

Contains pre-defined SPI sequences

Used by the testbench to simulate firmware behavior

Includes:

Register writes

Register reads

Status checks

Configuration operations

The testbench reads this file and applies the sequences step by step.

3. Interaction of HK SPI with Management SoC and User Project

Below is a short note suitable for your report.

The Housekeeping SPI is the main communication bridge between Caravel’s Management SoC and the Housekeeping controller. It allows the RISC-V core to configure, monitor, and manage both the internal settings of Caravel and the user project area.

3.1 Interaction with Management SoC

The RISC-V CPU acts as the SPI master and uses HK-SPI to:

Configure GPIO directions

Set analog/digital mode

Enable/disable user project clock

Apply resets to the user project

Read/write housekeeping registers

Manage system-level settings

All configuration during startup and runtime is handled through HK-SPI.

3.2 Housekeeping SPI as SPI Command Interpreter

The HK-SPI module:

Receives the SPI clock, chip-select, and MOSI data

Decodes addresses and command types

Performs read/write operations on internal registers

Sends response bytes over MISO

Ensures timing, protocol correctness, and data integrity

It acts as the controller that interprets SoC commands.

3.3 Interaction with User Project

Through registers controlled by HK-SPI, the following user project settings are managed:

GPIO configuration (input/output/analog)

User area enable/disable

Reset signal

Power gating

Functional mode selection

Thus, HK-SPI indirectly controls the operational state of the user project.

3.4 Purpose of the HK SPI Test

The hkspi DV test ensures:

Correct implementation of the SPI protocol

Accurate register read/write behavior

Proper interaction between HK-SPI, the SoC, and user project

RTL behavior matches GLS behavior

No regressions in housekeeping module functionality

This is one of the fundamental verification steps before tapeout.